<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP Gestão Inteligente - Cadastro de Cliente</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar Menu -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <a href="/painel" class="sidebar-item" title="Painel">
                <i class="fas fa-chart-bar"></i>
                <span class="sidebar-text">Painel</span>
            </a>
            <a href="clientes.html" class="sidebar-item" title="Clientes">
                <i class="fas fa-users"></i>
                <span class="sidebar-text">Clientes</span>
            </a>
        </div>
    </nav>

    <!-- Header azul escuro no topo -->
    <header class="top-header">
        <div class="header-container">
            <div class="header-left">
                <div class="header-logo">
                    <img src="assets/images/LOGO DO SISTEMA .png" alt="UP Gestão Inteligente" class="header-logo-img">
                    <!-- <span class="header-title">TRON</span> -->
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Seção de Listagem de Clientes (visível por padrão) -->
        <main class="clients-listing-section" id="clientsListingSection">
            <div class="form-header">
                <h2 class="form-title">Portfólio de Clientes</h2>
                <p class="form-subtitle">Gerencie seus clientes cadastrados</p>
            </div>
            
            <!-- Filtro de busca e botão adicionar -->
            <div class="listing-controls">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="clientSearchFilter" class="search-input" placeholder="Buscar cliente por nome amigavel...">
                    </div>
                </div>
                <div class="listing-controls-right">
                    <!-- Toggle Switch minimalista para Filtro de Status -->
                    <div class="status-toggle-minimal">
                        <span class="toggle-option-minimal" id="activeLabel">Ativos</span>
                        <div class="toggle-switch-minimal" id="statusToggle">
                            <input type="checkbox" id="statusToggleInput" class="toggle-input-minimal">
                            <label for="statusToggleInput" class="toggle-slider-minimal"></label>
                        </div>
                        <span class="toggle-option-minimal" id="inactiveLabel">Inativos</span>
                    </div>
                    <!-- Botão para Clientes Incompletos -->
                    <button class="incomplete-clients-btn" id="incompleteClientsBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Incompletos
                        <span class="incomplete-badge" id="incompleteBadge">0</span>
                    </button>
                    <button class="add-client-btn" id="addClientBtn">
                        <i class="fas fa-plus"></i>
                        Adicionar Cliente
                    </button>
                </div>
            </div>
            
            <!-- Descrição para clientes incompletos -->
            <div id="incompleteDescription" class="incomplete-description" style="display: none;">
                <p>Clientes com cadastro incompleto</p>
            </div>
            
            <!-- Lista de clientes -->
            <div class="clients-list-container">
                <div class="clients-simple-list" id="clientsSimpleList">
                    <div class="loading-message" id="clientsLoadingMessage">
                        <i class="fas fa-spinner fa-spin"></i>
                        Carregando clientes...
                    </div>
                </div>
            </div>
            
            <!-- Controles de Paginação -->
            <div class="pagination-container" id="paginationContainer" style="display: none;">
                <!-- Selector de itens por página -->
                <div class="pagination-limit-selector">
                    <label for="paginationLimit">Exibir:</label>
                    <select id="paginationLimit" class="pagination-limit-select">
                        <option value="10">10 itens</option>
                        <option value="20" selected>20 itens</option>
                        <option value="30">30 itens</option>
                    </select>
                </div>
                
                <!-- Informações de paginação -->
                <div class="pagination-info">
                    <span id="paginationInfo">Mostrando 0 de 0 clientes</span>
                </div>
                
                <!-- Botões de navegação -->
                <div class="pagination-controls">
                    <button id="firstPageBtn" class="pagination-btn" title="Primeira página">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button id="prevPageBtn" class="pagination-btn" title="Página anterior">
                        <i class="fas fa-angle-left"></i>
                    </button>
                    
                    <span class="pagination-current">
                        Página <span id="currentPageDisplay">1</span> de <span id="totalPagesDisplay">1</span>
                    </span>
                    
                    <button id="nextPageBtn" class="pagination-btn" title="Próxima página">
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button id="lastPageBtn" class="pagination-btn" title="Última página">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- Formulário de cadastro (oculto por padrão) -->
        <main class="main-content" id="clientFormSection" style="display: none;">
            <div class="form-header">
                <div class="form-header-top">
                    <button class="back-btn" id="backToListBtn">
                        <i class="fas fa-arrow-left"></i>
                        Voltar
                    </button>
                </div>
                <h2 class="form-title" id="formTitle">CADASTRAR CLIENTES</h2>
                <p class="form-subtitle" id="formSubtitle">Preencha os dados abaixo para cadastrar ou editar um cliente</p>
            </div>
            
            <div id="success-message" class="success-message">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Cliente cadastrado com sucesso!
            </div>
            
            <form id="clientForm" class="client-form">
                <div class="form-container">
                    <!-- Seção: Informações Básicas -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Informações Básicas
                        </h3>
                        <div class="section-separator"></div>
                        
                        <div class="section-fields">
                            <div class="form-group">
                                <label for="clienteClickup" class="form-label">Cliente ClickUp *</label>
                                <div class="searchable-select" id="clienteClickup-container">
                                    <input type="text" 
                                           id="clienteClickup-search" 
                                           class="form-input searchable-input" 
                                           placeholder="Digite para pesquisar..." 
                                           autocomplete="off"
                                           required>
                                    <input type="hidden" id="clienteClickup" name="clienteClickup" required>
                                    <div class="dropdown-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <ul class="dropdown-list" id="clienteClickup-list"></ul>
                                </div>
                                <div id="clienteClickup-error" class="error-message"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="razaoSocial" class="form-label">Razão Social *</label>
                                <input type="text" 
                                       id="razaoSocial" 
                                       name="razaoSocial" 
                                       class="form-input" 
                                       placeholder="Digite a razão social" 
                                       autocomplete="off"
                                       value=""
                                       required>
                                <div id="razaoSocial-error" class="error-message"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="nomeFantasia" class="form-label">Nome Fantasia *</label>
                                <input type="text" 
                                       id="nomeFantasia" 
                                       name="nomeFantasia" 
                                       class="form-input" 
                                       placeholder="Digite o nome fantasia" 
                                       required>
                                <div id="nomeFantasia-error" class="error-message"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="nomeAmigavel" class="form-label">Nome Amigável *</label>
                                <input type="text" 
                                       id="nomeAmigavel" 
                                       name="nomeAmigavel" 
                                       class="form-input" 
                                       placeholder="Digite o nome amigável" 
                                       required>
                                <div id="nomeAmigavel-error" class="error-message"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="teste" class="form-label">CNPJ|CONTRATO <span class="info-icon" title="O contrato é Cadastrado no CLICKUP"><i class="fas fa-info-circle"></i></span></label>
                                <div class="searchable-select" id="cnpj-container">
                                    <input type="text" 
                                           id="teste" 
                                           name="teste" 
                                           class="form-input searchable-input" 
                                           placeholder="Digite o CNPJ" 
                                           autocomplete="off">
                                    <div class="dropdown-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <ul class="dropdown-list" id="cnpj-list"></ul>
                                </div>
                                <div id="teste-error" class="error-message"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="testeDois" class="form-label">Status</label>
                                <div class="select-wrapper">
                                    <select id="testeDois" 
                                            name="testeDois" 
                                            class="form-input select-with-icon">
                                        <option value="">Selecione o status</option>
                                        <option value="ativo">Ativo</option>
                                        <option value="inativo">Inativo</option>
                                    </select>
                                    <i class="fas fa-chevron-down select-icon"></i>
                                </div>
                                <div id="testeDois-error" class="error-message"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="clienteKamino" class="form-label">Cliente Kamino *</label>
                                <div class="searchable-select" id="clienteKamino-container">
                                    <input type="text" 
                                           id="clienteKamino-search" 
                                           class="form-input searchable-input" 
                                           placeholder="Digite para pesquisar..." 
                                           autocomplete="off"
                                           required>
                                    <input type="hidden" id="clienteKamino" name="clienteKamino" required>
                                    <div class="dropdown-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <ul class="dropdown-list" id="clienteKamino-list"></ul>
                                </div>
                                <div id="clienteKamino-error" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                    

                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="limparFormulario()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Limpar
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitClientBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 14C19 18.4183 15.4183 22 11 22C6.58172 22 3 18.4183 3 14C3 9.58172 6.58172 6 11 6C15.4183 6 19 9.58172 19 14Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M9 11L11 13L15 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Salvar
                    </button>
                </div>
            </form>
        </main>
    </div>
    
    <!-- Modal de Grupos -->
    <div id="grupoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Selecionar Grupos</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="grupos-section">
                    <h4>Grupos Existentes</h4>
                    <div id="grupos-list" class="grupos-list">
                        <!-- Lista de grupos será carregada aqui -->
                    </div>
                </div>
                
                <div class="novo-grupo-section">
                    <h4>Criar Novo Grupo</h4>
                    <div class="novo-grupo-form">
                        <input type="text" 
                               id="novo-grupo-input" 
                               placeholder="Digite o nome do novo grupo" 
                               class="form-input">
                        <button type="button" 
                                id="confirmar-grupo-btn" 
                                class="btn-confirmar" 
                                >
                            Confirmar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancelar">Cancelar</button>
                <button type="button" class="btn-confirmar">Confirmar Seleção</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Produtos -->
    <div id="produtoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Criar Produto</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="novo-produto-section">
                    <h4>Dados do Produto</h4>
                    <div class="novo-produto-form">
                        <input type="text" 
                               id="novo-produto-input" 
                               placeholder="Digite o nome do produto" 
                               class="form-input">
                        <input type="text" 
                               id="novo-nome-clickup-input" 
                               placeholder="Digite o nome ClickUp" 
                               class="form-input">
                        <div class="select-wrapper">
                            <select id="novo-nome-clickup-select" 
                                    class="form-input select-with-icon">
                                <option value="">Selecione um produto ClickUp...</option>
                            </select>
                            <i class="fas fa-chevron-down select-icon"></i>
                        </div>
                        <input type="text" 
                               id="novo-nome-kamino-input" 
                               placeholder="Digite o nome Kamino" 
                               class="form-input">
                        <button type="button" 
                                id="confirmar-produto-btn" 
                                class="btn-confirmar" 
                                >
                            Confirmar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancelar">Cancelar</button>
                <button type="button" class="btn-confirmar">Confirmar Produto</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Clientes -->
    <div id="clientesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Clientes Cadastrados</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="clientes-list" id="clientes-list">
                    <!-- Lista de clientes será carregada aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancelar">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edição de Cliente -->
    <div id="editClienteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>CADASTRAR/EDITAR CLIENTE</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editClienteForm" class="edit-cliente-form">
                    <div class="form-group">
                        <label for="edit-clienteClickup" class="form-label">Cliente ClickUp *</label>
                        <div class="searchable-select" id="edit-clienteClickup-container">
                            <input type="text" 
                                   id="edit-clienteClickup-search" 
                                   class="form-input searchable-input" 
                                   placeholder="Digite para buscar cliente ClickUp..." 
                                   autocomplete="off">
                            <div class="dropdown-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <ul id="edit-clienteClickup-list" class="dropdown-list"></ul>
                        </div>
                        <input type="hidden" id="edit-cliente-clickup" name="cliente_clickup">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-razaoSocial" class="form-label">Razão Social *</label>
                        <input type="text" 
                               id="edit-razaoSocial" 
                               name="razao_social" 
                               class="form-input" 
                               placeholder="Digite a razão social" 
                               required>
                    </div>

                    <div class="form-group">
                                <label for="teste" class="form-label">CNPJ|CONTRATO <span class="info-icon" title="O contrato é Cadastrado no CLICKUP"><i class="fas fa-info-circle"></i></span></label>
                                <div class="searchable-select" id="cnpj-container">
                                    <input type="text" 
                                           id="teste" 
                                           name="teste" 
                                           class="form-input searchable-input" 
                                           placeholder="Digite o CNPJ" 
                                           autocomplete="off">
                                    <div class="dropdown-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <ul class="dropdown-list" id="cnpj-list"></ul>
                                </div>
                                <div id="teste-error" class="error-message"></div>
                            </div>
                            
                    
                    <div class="form-group">
                        <label for="edit-nomeFantasia" class="form-label">Nome Fantasia *</label>
                        <input type="text" 
                               id="edit-nomeFantasia" 
                               name="nome_fantasia" 
                               class="form-input" 
                               placeholder="Digite o nome fantasia" 
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-nomeAmigavel" class="form-label">Nome Amigável *</label>
                        <input type="text" 
                               id="edit-nomeAmigavel" 
                               name="nome_amigavel" 
                               class="form-input" 
                               placeholder="Digite o nome amigável" 
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-teste" class="form-label">CNPJ|CONTRATO <span class="info-icon" title="O contrato é Cadastrado no CLICKUP"><i class="fas fa-info-circle"></i></span></label>
                        <!-- <label for="text" class="form-label">CNPJ|CONTRATO <span class="info-icon" title="O contrato é Cadastrado no CLICKUP"><i class="fas fa-info-circle"></i></span></label> -->
                        <input type="text" 
                               id="edit-teste" 
                               name="teste" 
                               class="form-input" 
                               placeholder="Digite o CNPJ">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-testeDois" class="form-label">Status</label>
                        <div class="select-wrapper">
                            <select id="edit-testeDois" 
                                    name="teste_dois" 
                                    class="form-input select-with-icon">
                                <option value="">Selecione o status</option>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                            <i class="fas fa-chevron-down select-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-clienteKamino" class="form-label">Cliente Kamino *</label>
                        <div class="searchable-select" id="edit-clienteKamino-container">
                            <input type="text" 
                                   id="edit-clienteKamino-search" 
                                   class="form-input searchable-input" 
                                   placeholder="Digite para buscar cliente Kamino..." 
                                   autocomplete="off">
                            <div class="dropdown-arrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <ul id="edit-clienteKamino-list" class="dropdown-list"></ul>
                        </div>
                        <input type="hidden" id="edit-cliente-kamino" name="cliente_kamino">
                    </div>
                    
                    <input type="hidden" id="edit-cliente-id" name="cliente_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancelar">Cancelar</button>
                <button type="button" class="btn-confirmar" onclick="salvarEdicaoCliente()">Salvar Alterações</button>
            </div>
        </div>
    </div>
    
    <script src="auth-check.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Variáveis globais para a nova funcionalidade
        let allClients = [];
        let filteredClients = [];
        let currentPage = 1;
        let itemsPerPage = 20;
        let totalPages = 1;
        let totalClients = 0;
        let searchTerm = '';
        
        // Controle de requisições (evitar race conditions)
        let isLoadingClients = false;
        let currentRequestController = null;
        
        // Elementos DOM
        const clientsListingSection = document.getElementById('clientsListingSection');
        const clientFormSection = document.getElementById('clientFormSection');
        const addClientBtn = document.getElementById('addClientBtn');
        const backToListBtn = document.getElementById('backToListBtn');
        const clientSearchFilter = document.getElementById('clientSearchFilter');
        const clientsSimpleList = document.getElementById('clientsSimpleList');
        const clientsLoadingMessage = document.getElementById('clientsLoadingMessage');
        
        // Função para carregar clientes da API (mesma lógica da página de clientes)
        async function loadClients() {
            // Evitar múltiplas chamadas simultâneas (race condition)
            if (isLoadingClients) {
                return;
            }
            
            // Cancelar requisição anterior se existir
            if (currentRequestController) {
                currentRequestController.abort();
            }
            
            // Criar novo AbortController para esta requisição
            currentRequestController = new AbortController();
            const timeoutId = setTimeout(() => {
                currentRequestController.abort();
            }, 15000); // Timeout de 15 segundos
            
            try {
                isLoadingClients = true;
                showLoadingMessage();
                
                // Buscar clientes do portfólio pela tabela cp_cliente
                let url = `/api/portifolio-clientes?page=${currentPage}&limit=${itemsPerPage}`;
                
                // Adicionar filtro de busca se existir
                if (searchTerm && searchTerm.trim() !== '') {
                    url += `&search=${encodeURIComponent(searchTerm.trim())}`;
                }
                
                // Adicionar filtro de status (apenas se não estiver mostrando incompletos)
                if (currentStatusFilter && !showIncompleteClients) {
                    url += `&status=${encodeURIComponent(currentStatusFilter)}`;
                }
                
                // Adicionar filtro de clientes incompletos
                if (showIncompleteClients) {
                    url += `&incompletos=true`;
                }
                
                const response = await fetch(url, {
                    credentials: 'include',
                    signal: currentRequestController.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Não autorizado, redirecionar para login
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`Erro ao carregar clientes (${response.status})`);
                }
                
                const data = await response.json();
                
                if (!data || !data.success) {
                    throw new Error(data.message || 'Erro ao carregar clientes');
                }
                
                // Processar clientes da mesma forma que a página de clientes
                const clientesRaw = Array.isArray(data.data) ? data.data : [];
                
                filteredClients = clientesRaw.map(cliente => {
                    const nomeExtraido = cliente.nome || cliente.nome_amigavel || cliente.nome_fantasia || cliente.razao_social || 'Nome não informado';
                    return {
                        id: cliente.id,
                        nome: nomeExtraido,
                        status: cliente.status || 'ativo',
                        clickupNome: cliente.nome || '',
                        raw: cliente
                    };
                });
                
                // Atualizar paginação com dados do backend
                updatePagination(data);
                renderClientsList();
                
                // Atualizar estado visual do botão de incompletos
                updateIncompleteButtonState();
                
                // Atualizar subtítulo
                updateSubtitle();
            } catch (error) {
                clearTimeout(timeoutId);
                
                // Ignorar erros de cancelamento (AbortError)
                if (error.name === 'AbortError') {
                    return;
                }
                
                // Tratamento específico de erros
                if (error.message.includes('401')) {
                    window.location.href = '/login';
                    return;
                }
                
                showErrorMessage('Erro ao carregar a lista de clientes. Por favor, tente novamente.');
            } finally {
                isLoadingClients = false;
                currentRequestController = null;
            }
        }
        
        // Função para atualizar o estado visual do botão de incompletos
        function updateIncompleteButtonState() {
            const incompleteBtn = document.getElementById('incompleteClientsBtn');
            if (incompleteBtn) {
                if (showIncompleteClients) {
                    incompleteBtn.classList.add('active');
                } else {
                    incompleteBtn.classList.remove('active');
                }
            }
        }
        
        // Função para atualizar o subtítulo e descrição baseado no filtro
        function updateSubtitle() {
            const subtitle = document.querySelector('.form-subtitle');
            const incompleteDescription = document.getElementById('incompleteDescription');
            
            if (showIncompleteClients) {
                // Esconder subtítulo quando estiver mostrando incompletos
                if (subtitle) {
                    subtitle.style.display = 'none';
                }
                // Mostrar descrição de incompletos
                if (incompleteDescription) {
                    incompleteDescription.style.display = 'block';
                }
            } else {
                // Mostrar subtítulo quando não estiver mostrando incompletos
                if (subtitle) {
                    subtitle.style.display = 'block';
                    if (currentStatusFilter === 'ativo') {
                        subtitle.textContent = 'Gerencie seus clientes ATIVOS';
                    } else if (currentStatusFilter === 'inativo') {
                        subtitle.textContent = 'Gerencie seus clientes Inativos';
                    } else {
                        subtitle.textContent = 'Gerencie seus clientes cadastrados';
                    }
                }
                // Esconder descrição de incompletos
                if (incompleteDescription) {
                    incompleteDescription.style.display = 'none';
                }
            }
        }
        
        // Função para atualizar paginação (usando dados do backend)
        function updatePagination(paginationData) {
            totalClients = paginationData.total || 0;
            totalPages = paginationData.totalPages || 1;
            currentPage = paginationData.page || 1;
            
            updatePaginationUI();
        }
        
        // Função para atualizar UI de paginação
        function updatePaginationUI() {
            const paginationContainer = document.getElementById('paginationContainer');
            const paginationInfo = document.getElementById('paginationInfo');
            const currentPageDisplay = document.getElementById('currentPageDisplay');
            const totalPagesDisplay = document.getElementById('totalPagesDisplay');
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            
            // Calcular range de itens exibidos
            const startItem = totalClients === 0 ? 0 : ((currentPage - 1) * itemsPerPage) + 1;
            const endItem = Math.min(startItem + Math.min(itemsPerPage, filteredClients.length) - 1, totalClients);
            
            // Atualizar informações
            paginationInfo.textContent = `Mostrando ${startItem} a ${endItem} de ${totalClients} clientes`;
            currentPageDisplay.textContent = currentPage;
            totalPagesDisplay.textContent = totalPages;
            
            // Habilitar/desabilitar botões
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            // Mostrar controles de paginação se houver clientes
            if (totalClients > 0) {
                paginationContainer.style.display = 'flex';
            } else {
                paginationContainer.style.display = 'none';
            }
        }
        
        // Função para ir para página específica
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadClients();
        }
        
        // Função para mostrar mensagem de carregamento
        function showLoadingMessage() {
            clientsSimpleList.innerHTML = `
                <div class="loading-message">
                    <i class="fas fa-spinner fa-spin"></i>
                    Carregando clientes...
                </div>
            `;
        }
        
        // Função para mostrar mensagem de erro
        function showErrorMessage(message) {
            clientsSimpleList.innerHTML = `
                <div class="no-clients-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // Função para renderizar a lista de clientes
        function renderClientsList() {
            if (filteredClients.length === 0) {
                clientsSimpleList.innerHTML = `
                    <div class="no-clients-message">
                        <i class="fas fa-users"></i>
                        <p>Nenhum cliente encontrado</p>
                    </div>
                `;
                return;
            }
            
            // Renderizar diretamente os clientes já paginados pelo backend
            const clientsHTML = filteredClients.map(client => {
                // Usar o campo nome já processado
                const clientName = client.nome || 'Cliente sem nome';
                const isAtivo = client.status === 'ativo';
                const statusClass = isAtivo ? 'status-ativo' : 'status-inativo';
                const statusText = isAtivo ? 'Ativo' : 'Inativo';
                
                // Mostrar botão apropriado baseado no status do cliente
                const statusButton = isAtivo ? `
                    <button class="client-action-btn inactivate-btn" onclick="showInactivateModal('${client.id}', '${clientName.replace(/'/g, "\\'")}')" title="Inativar cliente">
                        <i class="fas fa-ban"></i>
                    </button>
                ` : `
                    <button class="client-action-btn activate-btn" onclick="showActivateModal('${client.id}', '${clientName.replace(/'/g, "\\'")}')" title="Ativar cliente">
                        <i class="fas fa-check-circle"></i>
                    </button>
                `;
                const renderInlineForm = () => {
                    const c = client.raw || {};
                    const razao = c.razao_social || '';
                    const fantasia = c.nome_fantasia || '';
                    const amigavel = c.nome_amigavel || '';
                    const cnpj = c.cpf_cnpj || c.cnpj_cpf || '';
                    const statusVal = c.status || '';
                    const kamino = c.nome_cli_kamino || c.cli_kamino || '';
                    const id = client.id;
                    return `
                        <div class="section-fields" style="margin-top:8px;font-size:12px;">
                            <div class="form-grid" style="grid-template-columns: repeat(3, minmax(140px, 1fr)); align-items: center; gap: 6px; margin-bottom:6px;">
                                <div class="form-group">
                                    <label class="form-label">Razão Social*</label>
                                    <input type="text" class="form-input" id="inline-razao-${id}" placeholder="Digite a razão social" value="${razao}" style="max-width:160px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">N. Fantasia *</label>
                                    <input type="text" class="form-input" id="inline-fantasia-${id}" placeholder="Digite o nome fantasia" value="${fantasia}" style="max-width:160px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">N. Amigável *</label>
                                    <input type="text" class="form-input" id="inline-amigavel-${id}" placeholder="Digite o nome amigável" value="${amigavel}" style="max-width:160px;">
                                </div>
                            </div>
                            <div class="form-grid" style="grid-template-columns: repeat(3, minmax(140px, 1fr)); align-items: center; gap: 6px;">
                                <div class="form-group">
                                    <label class="form-label">CNPJ|Contrato</label>
                                    <div class="searchable-select" id="inline-cnpj-container-${id}">
                                        <input type="text" class="form-input searchable-input" id="inline-cnpj-${id}" placeholder="Digite o CNPJ" autocomplete="off" value="${cnpj}" style="max-width:160px;">
                                        <div class="dropdown-arrow"><i class="fas fa-chevron-down"></i></div>
                                        <ul class="dropdown-list" id="inline-cnpj-list-${id}" style="display:none;"></ul>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <div class="select-wrapper">
                                        <select class="form-input select-with-icon" id="inline-status-${id}" style="max-width:160px;">
                                            <option value="">Selecione o status</option>
                                            <option value="ativo" ${statusVal==='ativo'?'selected':''}>Ativo</option>
                                            <option value="inativo" ${statusVal==='inativo'?'selected':''}>Inativo</option>
                                        </select>
                                        <i class="fas fa-chevron-down select-icon"></i>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cliente Kamino *</label>
                                    <div class="searchable-select" id="inline-kamino-container-${id}">
                                        <input type="text" class="form-input searchable-input" id="inline-kamino-search-${id}" placeholder="Digite para pesquisar..." autocomplete="off" value="${kamino}" style="max-width:160px;">
                                        <input type="hidden" id="inline-kamino-hidden-${id}">
                                        <div class="dropdown-arrow"><i class="fas fa-chevron-down"></i></div>
                                        <ul class="dropdown-list" id="inline-kamino-list-${id}" style="display:none;"></ul>
                                    </div>
                                </div>
                            </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end;">
                            <button class="client-action-btn activate-btn" type="button" title="Salvar cliente" onclick="salvarClienteInline('${id}')"><i class="fas fa-check"></i></button>
                        </div>
                        </div>
                    `;
                };

                const inlineFormHTML = showIncompleteClients ? renderInlineForm() : '';

                return `
                    <div class="client-list-item ${statusClass}" data-client-id="${client.id}" data-client-status="${client.status}">
                        <p class="client-name">${clientName}</p>
                        <div class="client-actions">
                            <button class="client-action-btn edit-btn" onclick="editClient('${client.id}', '${clientName.replace(/'/g, "\\'")}', '${(client.clickupNome || '').replace(/'/g, "\\'")}')" title="Editar cliente">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            ${statusButton}
                        </div>
                        ${inlineFormHTML}
                    </div>
                `;
            }).join('');
            
            clientsSimpleList.innerHTML = clientsHTML;
            initInlineCnpjForClients();
            initInlineKaminoForClients();
            updatePaginationUI();
        }

        async function salvarClienteInline(id) {
            try {
                const razao = document.getElementById(`inline-razao-${id}`)?.value || '';
                const fantasia = document.getElementById(`inline-fantasia-${id}`)?.value || '';
                const amigavel = document.getElementById(`inline-amigavel-${id}`)?.value || '';
                const cnpj = document.getElementById(`inline-cnpj-${id}`)?.value || '';
                const status = document.getElementById(`inline-status-${id}`)?.value || '';
                const kaminoNome = document.getElementById(`inline-kamino-search-${id}`)?.value || '';
                const kaminoId = document.getElementById(`inline-kamino-hidden-${id}`)?.value || '';

                const body = {
                    razao_social: razao,
                    nome_fantasia: fantasia,
                    nome_amigavel: amigavel,
                    cpf_cnpj: cnpj,
                    status: status || null,
                    nome_cli_kamino: kaminoNome,
                    id_cli_kamino: kaminoId || null
                };

                const resp = await fetch(`/api/clientes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    credentials: 'include'
                });
                if (!resp.ok) {
                    const txt = await resp.text();
                    alert(`Erro ao salvar: ${txt}`);
                    return;
                }
                await loadClients();
                showMessage('Cliente atualizado com sucesso!', 'success');
            } catch (err) {
                alert(`Falha ao salvar: ${err.message}`);
            }
        }

        function initInlineCnpjForClients() {
            if (!showIncompleteClients) return;
            (filteredClients || []).forEach(client => {
                const id = client.id;
                const clickupName = client.clickupNome || '';
                const container = document.getElementById(`inline-cnpj-container-${id}`);
                const input = document.getElementById(`inline-cnpj-${id}`);
                const list = document.getElementById(`inline-cnpj-list-${id}`);
                if (!container || !input || !list) return;

                if (clickupName && clickupName.trim() !== '') {
                    loadInlineCnpjOptionsFromContratos(clickupName, id);
                } else {
                    list.innerHTML = '';
                    list.style.display = 'none';
                }

                input.addEventListener('input', function(e) {
                    if (typeof aplicarMascaraCpfCnpj === 'function') {
                        const valorFormatado = aplicarMascaraCpfCnpj(e.target.value || '');
                        e.target.value = valorFormatado;
                    }
                });
                input.addEventListener('keypress', function(e) {
                    if (!/[0-9]/.test(e.key) && !['Backspace','Delete','Tab','Escape','Enter','ArrowLeft','ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
                input.addEventListener('focus', function() {
                    if (list && list.children.length > 0) list.style.display = 'block';
                });
                input.addEventListener('blur', function() {
                    setTimeout(() => { if (list) list.style.display = 'none'; }, 150);
                });
                const arrow = container.querySelector('.dropdown-arrow');
                if (arrow) {
                    arrow.addEventListener('click', function() {
                        if (list) {
                            const isVisible = list.style.display === 'block';
                            list.style.display = isVisible ? 'none' : 'block';
                        }
                    });
                }
            });
        }

        async function loadInlineCnpjOptionsFromContratos(clickupName, id) {
            try {
                const list = document.getElementById(`inline-cnpj-list-${id}`);
                if (!list) return;
                list.innerHTML = '';
                const url = `/api/contratos-cliente/${encodeURIComponent(String(clickupName).trim())}`;
                const response = await fetch(url, { credentials: 'include' });
                if (!response.ok) {
                    list.style.display = 'none';
                    return;
                }
                const result = await response.json();
                const valores = (result && result.success && Array.isArray(result.data))
                    ? Array.from(new Set(result.data.map(c => c.cpf_cnpj).filter(v => v && v !== 'N/A')))
                    : [];
                valores.forEach(valor => {
                    const item = document.createElement('li');
                    item.className = 'dropdown-item';
                    item.textContent = valor;
                    item.addEventListener('click', () => {
                        const input = document.getElementById(`inline-cnpj-${id}`);
                        if (!input) return;
                        if (typeof aplicarMascaraCpfCnpj === 'function') {
                            input.value = aplicarMascaraCpfCnpj(valor);
                        } else {
                            input.value = valor;
                        }
                        list.style.display = 'none';
                    });
                    list.appendChild(item);
                });
                list.style.display = 'none';
            } catch (_) {
                const list = document.getElementById(`inline-cnpj-list-${id}`);
                if (list) {
                    list.innerHTML = '';
                    list.style.display = 'none';
                }
            }
        }

        function initInlineKaminoForClients() {
            if (!showIncompleteClients) return;
            (filteredClients || []).forEach(client => {
                const id = client.id;
                const container = document.getElementById(`inline-kamino-container-${id}`);
                const input = document.getElementById(`inline-kamino-search-${id}`);
                const hidden = document.getElementById(`inline-kamino-hidden-${id}`);
                const list = document.getElementById(`inline-kamino-list-${id}`);
                if (!container || !input || !list) return;
                if (window.setupSearchableDropdownKaminoGeneric) {
                    window.setupSearchableDropdownKaminoGeneric(
                        `inline-kamino-container-${id}`,
                        `inline-kamino-search-${id}`,
                        `inline-kamino-list-${id}`,
                        `inline-kamino-hidden-${id}`
                    );
                } else {
                    input.addEventListener('input', function(e) {
                        filterInlineKaminoOptions(id, e.target.value || '');
                        list.style.display = 'block';
                    });
                    input.addEventListener('focus', function() {
                        filterInlineKaminoOptions(id, input.value || '');
                        list.style.display = 'block';
                    });
                    const arrow = container.querySelector('.dropdown-arrow');
                    if (arrow) {
                        arrow.addEventListener('click', function() {
                            if (list) {
                                const isVisible = list.style.display === 'block';
                                if (!isVisible) filterInlineKaminoOptions(id, input.value || '');
                                list.style.display = isVisible ? 'none' : 'block';
                            }
                        });
                    }
                    document.addEventListener('click', function(e) {
                        if (!e.target.closest(`#inline-kamino-container-${id}`)) {
                            list.style.display = 'none';
                        }
                    });
                }
            });
        }

        function renderInlineKaminoOptions(id, searchTerm) {
            try {
                const list = document.getElementById(`inline-kamino-list-${id}`);
                const input = document.getElementById(`inline-kamino-search-${id}`);
                const hidden = document.getElementById(`inline-kamino-hidden-${id}`);
                if (!list || !input || !hidden) return;
                list.innerHTML = '';
                if (!Array.isArray(window.allClientesKamino)) return;
                const lower = String(searchTerm || '').toLowerCase();
                const filtered = window.allClientesKamino.filter(c => {
                    const nomeFantasia = (c.nome_fantasia || '').toLowerCase();
                    const razaoSocial = (c.razao_social || '').toLowerCase();
                    const nome = (c.nome || '').toLowerCase();
                    return nomeFantasia.includes(lower) || razaoSocial.includes(lower) || nome.includes(lower);
                });
                filtered.forEach(c => {
                    const item = document.createElement('li');
                    item.className = 'dropdown-item';
                    const nomeExibicao = c.nome_fantasia || c.razao_social || c.nome || 'Cliente sem nome';
                    item.textContent = nomeExibicao;
                    item.addEventListener('click', () => {
                        input.value = nomeExibicao;
                        const idMap = (window.clientesKaminoMap && window.clientesKaminoMap.get) ? window.clientesKaminoMap.get(c.nome_fantasia || nomeExibicao) : c.id;
                        hidden.value = idMap || c.id || '';
                        list.style.display = 'none';
                    });
                    list.appendChild(item);
                });
            } catch (_) {}
        }

        function filterInlineKaminoOptions(id, searchTerm) {
            try {
                const list = document.getElementById(`inline-kamino-list-${id}`);
                if (!list) return;
                renderInlineKaminoOptions(id, searchTerm || '');
            } catch (_) {}
        }
        
        // Variáveis para o modal de inativação
        let currentClientId = null;
        let currentClientName = null;
        
        // Função para mostrar mensagens
        function showMessage(message, type = 'info') {
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Adicionar estilos inline
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            
            // Adicionar ao body
            document.body.appendChild(notification);
            
            // Remover após 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Função para mostrar o modal de confirmação
        function showInactivateModal(clienteId, clienteName) {
            if (!clienteId || !clienteName) {
                return;
            }
            
            currentClientId = clienteId;
            currentClientName = clienteName;
            
            // Atualizar o nome do cliente no modal
            const modalNameSpan = document.getElementById('modalClientName');
            if (modalNameSpan) {
                modalNameSpan.textContent = clienteName;
            }
            
            // Mostrar o modal
            const modal = document.getElementById('inactivateModal');
            if (modal) {
                modal.style.display = 'flex';
            }
            
            // Adicionar event listener para o botão de confirmação
            const confirmBtn = document.getElementById('confirmInactivateBtn');
            if (confirmBtn) {
                confirmBtn.onclick = confirmInactivateClient;
            }
        }
        
        // Função para fechar o modal
        function closeInactivateModal() {
            document.getElementById('inactivateModal').style.display = 'none';
            currentClientId = null;
            currentClientName = null;
        }
        
        // Função para confirmar a inativação
        async function confirmInactivateClient() {
            if (!currentClientId) {
                showMessage('Erro: ID do cliente não encontrado', 'error');
                return;
            }
            
            // Mostrar loading no botão
            const confirmBtn = document.getElementById('confirmInactivateBtn');
            if (!confirmBtn) {
                return;
            }
            
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Inativando...';
            confirmBtn.disabled = true;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos
                
                const response = await fetch(`/api/clientes/${currentClientId}/inativar`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Fechar modal
                    closeInactivateModal();
                    
                    // Mostrar mensagem de sucesso
                    showMessage('Cliente inativado com sucesso!', 'success');
                    
                    // Recarregar a lista para atualizar o status
                    loadClients();
                    // Recarregar contagem de incompletos após mudança
                    loadIncompleteClientsCount();
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('Requisição cancelada. Tempo de espera excedido.', 'error');
                } else if (error.message) {
                    showMessage('Erro ao inativar cliente: ' + error.message, 'error');
                } else {
                    showMessage('Erro ao inativar cliente. Por favor, tente novamente.', 'error');
                }
            } finally {
                // Restaurar botão
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        // Fechar modal ao clicar fora dele
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('inactivateModal');
            if (event.target === modal) {
                closeInactivateModal();
            }
        });

        // ===== FUNCIONALIDADES DE ATIVAÇÃO =====
        
        // Função para mostrar o modal de confirmação de ativação
        function showActivateModal(clienteId, clienteName) {
            if (!clienteId || !clienteName) {
                return;
            }
            
            currentClientId = clienteId;
            currentClientName = clienteName;
            
            // Atualizar o nome do cliente no modal
            const modalNameSpan = document.getElementById('modalActivateClientName');
            if (modalNameSpan) {
                modalNameSpan.textContent = clienteName;
            }
            
            // Mostrar o modal
            const modal = document.getElementById('activateModal');
            if (modal) {
                modal.style.display = 'flex';
            }
            
            // Adicionar event listener para o botão de confirmação
            const confirmBtn = document.getElementById('confirmActivateBtn');
            if (confirmBtn) {
                confirmBtn.onclick = confirmActivateClient;
            }
        }
        
        // Função para fechar o modal de ativação
        function closeActivateModal() {
            document.getElementById('activateModal').style.display = 'none';
            currentClientId = null;
            currentClientName = null;
        }
        
        // Função para confirmar a ativação
        async function confirmActivateClient() {
            if (!currentClientId) {
                showMessage('Erro: ID do cliente não encontrado', 'error');
                return;
            }
            
            // Mostrar loading no botão
            const confirmBtn = document.getElementById('confirmActivateBtn');
            if (!confirmBtn) {
                return;
            }
            
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ativando...';
            confirmBtn.disabled = true;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos
                
                const response = await fetch(`/api/clientes/${currentClientId}/ativar`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Fechar modal
                    closeActivateModal();
                    
                    // Mostrar mensagem de sucesso
                    showMessage('Cliente ativado com sucesso!', 'success');
                    
                    // Recarregar a lista para atualizar o status
                    loadClients();
                    // Recarregar contagem de incompletos após mudança
                    loadIncompleteClientsCount();
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('Requisição cancelada. Tempo de espera excedido.', 'error');
                } else if (error.message) {
                    showMessage('Erro ao ativar cliente: ' + error.message, 'error');
                } else {
                    showMessage('Erro ao ativar cliente. Por favor, tente novamente.', 'error');
                }
            } finally {
                // Restaurar botão
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        // Fechar modal de ativação ao clicar fora dele
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('activateModal');
            if (event.target === modal) {
                closeActivateModal();
            }
        });

        // ===== FUNCIONALIDADE DE EDIÇÃO =====
        
        // Função para editar cliente (alternar para modo de cadastro com cliente selecionado)
        function editClient(clienteId, clienteName, clickupName) {
            if (!clienteId) {
                return;
            }
            
            // Alternar para o modo de cadastro
            showClientForm();
            
            // Aguardar um pouco para garantir que o formulário foi carregado
            setTimeout(() => {
                // Chamar diretamente a função de seleção por ID
                if (typeof selecionarClientePorId === 'function') {
                    selecionarClientePorId(clienteId);
                }
                
                disableClienteClickupField(clickupName);
                if (clickupName && clickupName.trim() !== '') {
                    if (typeof loadCnpjOptionsFromContratos === 'function') {
                        loadCnpjOptionsFromContratos(clickupName);
                    }
                    if (typeof carregarDadosContratos === 'function') {
                        carregarDadosContratos(clickupName);
                    }
                }
                
                // Atualizar título após seleção (modo edição)
                setTimeout(() => {
                    updateFormTitle();
                }, 300);
            }, 500); // Aumentar o tempo para garantir que tudo foi carregado
        }

        function disableClienteClickupField(presetName) {
            const search = document.getElementById('clienteClickup-search');
            const hidden = document.getElementById('clienteClickup');
            if (search) {
                if (presetName && presetName.trim() !== '') {
                    search.value = presetName;
                    if (hidden) {
                        hidden.value = presetName;
                    }
                }
                search.setAttribute('readonly', 'readonly');
                search.setAttribute('disabled', 'disabled');
            }
        }

        function enableClienteClickupField() {
            const search = document.getElementById('clienteClickup-search');
            if (search) {
                search.removeAttribute('readonly');
                search.removeAttribute('disabled');
            }
            clearCnpjOptions();
        }

        function clearCnpjOptions() {
            const list = document.getElementById('cnpj-list');
            if (list) {
                list.innerHTML = '';
            }
        }
        
        // Função para filtrar clientes (redireciona busca para backend)
        function filterClients(searchTermValue) {
            searchTerm = searchTermValue;
            // Resetar para primeira página ao filtrar
            currentPage = 1;
            loadClients();
        }
        
        // Função para atualizar o título e subtítulo baseado no modo (cadastrar/editar)
        function updateFormTitle() {
            const formTitle = document.getElementById('formTitle');
            const formSubtitle = document.getElementById('formSubtitle');
            const clienteClickupInput = document.getElementById('clienteClickup');
            const clienteClickupSearch = document.getElementById('clienteClickup-search');
            
            if (!formTitle || !formSubtitle) {
                return;
            }
            
            // Verificar se há um cliente selecionado (modo edição)
            // Verificar tanto o campo hidden quanto o campo de busca
            const hasClienteSelected = (clienteClickupInput && clienteClickupInput.value && clienteClickupInput.value.trim() !== '') ||
                                       (clienteClickupSearch && clienteClickupSearch.value && clienteClickupSearch.value.trim() !== '');
            
            if (hasClienteSelected) {
                formTitle.textContent = 'CADASTRAR/EDITAR CLIENTE';
                formSubtitle.textContent = 'Altere os dados abaixo para atualizar o cliente';
            } else {
                formTitle.textContent = 'CADASTRAR CLIENTES';
                formSubtitle.textContent = 'Preencha os dados abaixo para cadastrar um novo cliente';
            }
        }
        
        // Observar mudanças no campo Cliente ClickUp para atualizar o título
        function observeClienteClickupChanges() {
            const clienteClickupInput = document.getElementById('clienteClickup');
            const clienteClickupSearch = document.getElementById('clienteClickup-search');
            
            // Observer para o campo hidden via eventos
            if (clienteClickupInput) {
                clienteClickupInput.addEventListener('change', updateFormTitle);
            }
            
            // Observer para o campo de busca
            if (clienteClickupSearch) {
                clienteClickupSearch.addEventListener('input', () => {
                    setTimeout(updateFormTitle, 100);
                });
                clienteClickupSearch.addEventListener('change', updateFormTitle);
            }
        }
        
        // Função para mostrar o formulário de cadastro
        function showClientForm() {
            clientsListingSection.style.display = 'none';
            clientFormSection.style.display = 'block';
            enableClienteClickupField();
            clearCnpjOptions();
            
            // Atualizar título baseado no estado do formulário
            setTimeout(() => {
                updateFormTitle();
                observeClienteClickupChanges();
            }, 100);
        }
        
        // Função para mostrar a listagem de clientes
        function showClientsList() {
            clientFormSection.style.display = 'none';
            clientsListingSection.style.display = 'block';
            enableClienteClickupField();
            
            // Limpar o formulário
            const form = document.getElementById('clientForm');
            if (form) {
                form.reset();
                // Limpar campos hidden também
                const hiddenInputs = form.querySelectorAll('input[type="hidden"]');
                hiddenInputs.forEach(input => input.value = '');
                
                // Limpar campos de busca dos selects
                const searchInputs = form.querySelectorAll('.searchable-input');
                searchInputs.forEach(input => input.value = '');
            }
            clearCnpjOptions();
            
            // Recarregar a lista de clientes
            loadClients();
        }
        
        // Inicializar paginação
        function initializePagination() {
            document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
            document.getElementById('prevPageBtn').addEventListener('click', () => goToPage(currentPage - 1));
            document.getElementById('nextPageBtn').addEventListener('click', () => goToPage(currentPage + 1));
            document.getElementById('lastPageBtn').addEventListener('click', () => goToPage(totalPages));
            
            document.getElementById('paginationLimit').addEventListener('change', (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 1;
                loadClients();
            });
        }
        
        // Debounce para busca
        let searchTimeout;
        function handleSearch(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterClients(e.target.value);
            }, 500);
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar paginação
            initializePagination();
            
            // Carregar clientes ao inicializar a página
            loadClients();
            
            // Carregar contagem de clientes incompletos
            loadIncompleteClientsCount();
            
            // Botão "Adicionar Cliente"
            addClientBtn.addEventListener('click', showClientForm);
            
            // Botão "Voltar"
            backToListBtn.addEventListener('click', showClientsList);
            
            // Botão "Clientes Incompletos"
            const incompleteClientsBtn = document.getElementById('incompleteClientsBtn');
            if (incompleteClientsBtn) {
                incompleteClientsBtn.addEventListener('click', toggleIncompleteClients);
            }
            
            // Filtro de busca com debounce
            clientSearchFilter.addEventListener('input', handleSearch);
            
            // Interceptar o evento de sucesso do cadastro para voltar à listagem
            const originalSuccessHandler = window.showSuccessMessage;
            window.showSuccessMessage = function(message) {
                if (originalSuccessHandler) {
                    originalSuccessHandler(message);
                }
                
                // Aguardar um pouco e voltar para a listagem
                setTimeout(() => {
                    showClientsList();
                }, 2000);
            };
        });
        
        // Interceptar o submit do formulário para atualizar a lista após cadastro
        document.addEventListener('DOMContentLoaded', function() {
            const clientForm = document.getElementById('clientForm');
            if (clientForm) {
                const originalSubmitHandler = clientForm.onsubmit;
                
                clientForm.addEventListener('submit', function(e) {
                    // Permitir que o formulário seja processado normalmente
                    // A função showSuccessMessage já foi modificada para voltar à listagem
                });
            }
        });

        // ===== FUNCIONALIDADE DO TOGGLE SWITCH PARA FILTRO DE STATUS =====
        let currentStatusFilter = 'ativo'; // Por padrão, mostrar clientes ativos
        let showIncompleteClients = false; // Controla se está mostrando clientes incompletos
        
        // Inicializar toggle switch quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            initializeStatusToggle();
        });
        
        function initializeStatusToggle() {
            const toggleInput = document.getElementById('statusToggleInput');
            const activeLabel = document.getElementById('activeLabel');
            const inactiveLabel = document.getElementById('inactiveLabel');
            
            if (!toggleInput || !activeLabel || !inactiveLabel) return;
            
            // Configurar estado inicial (Ativos selecionado)
            toggleInput.checked = false; // false = Ativos, true = Inativos
            currentStatusFilter = 'ativo'; // Garantir que o filtro inicial seja 'ativo'
            updateToggleLabels();
            
            // Carregar clientes inicialmente com o filtro ativo
            loadClients();
            
            // Atualizar subtítulo inicial
            updateSubtitle();
            
            // Adicionar event listener para mudanças no toggle
            toggleInput.addEventListener('change', function() {
                currentStatusFilter = this.checked ? 'inativo' : 'ativo';
                updateToggleLabels();
                
                // Desativar filtro de incompletos se estiver ativo
                if (showIncompleteClients) {
                    showIncompleteClients = false;
                    const incompleteBtn = document.getElementById('incompleteClientsBtn');
                    if (incompleteBtn) {
                        incompleteBtn.classList.remove('active');
                    }
                }
                
                // Recarregar a lista com o novo filtro
                currentPage = 1; // Resetar para primeira página
                loadClients();
                
                // Atualizar subtítulo
                updateSubtitle();
            });
            
            // Adicionar clique nos labels para alternar o toggle
            activeLabel.addEventListener('click', function() {
                if (currentStatusFilter !== 'ativo') {
                    toggleInput.checked = false;
                    currentStatusFilter = 'ativo';
                    updateToggleLabels();
                    
                    // Desativar filtro de incompletos se estiver ativo
                    if (showIncompleteClients) {
                        showIncompleteClients = false;
                        const incompleteBtn = document.getElementById('incompleteClientsBtn');
                        if (incompleteBtn) {
                            incompleteBtn.classList.remove('active');
                        }
                    }
                    
                    currentPage = 1;
                    loadClients();
                    
                    // Atualizar subtítulo
                    updateSubtitle();
                }
            });
            
            inactiveLabel.addEventListener('click', function() {
                if (currentStatusFilter !== 'inativo') {
                    toggleInput.checked = true;
                    currentStatusFilter = 'inativo';
                    updateToggleLabels();
                    
                    // Desativar filtro de incompletos se estiver ativo
                    if (showIncompleteClients) {
                        showIncompleteClients = false;
                        const incompleteBtn = document.getElementById('incompleteClientsBtn');
                        if (incompleteBtn) {
                            incompleteBtn.classList.remove('active');
                        }
                    }
                    
                    currentPage = 1;
                    loadClients();
                    
                    // Atualizar subtítulo
                    updateSubtitle();
                }
            });
        }
        
        function updateToggleLabels() {
            const activeLabel = document.getElementById('activeLabel');
            const inactiveLabel = document.getElementById('inactiveLabel');
            
            if (!activeLabel || !inactiveLabel) return;
            
            // Remover classe active de ambos
            activeLabel.classList.remove('active');
            inactiveLabel.classList.remove('active');
            
            // Adicionar classe active ao label correspondente
            if (currentStatusFilter === 'ativo') {
                activeLabel.classList.add('active');
            } else {
                inactiveLabel.classList.add('active');
            }
        }

         // ===== FUNCIONALIDADE DO BOTÃO DE CLIENTES INCOMPLETOS =====
         async function loadIncompleteClientsCount() {
             try {
                 const controller = new AbortController();
                 const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos
                 
                 const response = await fetch('/api/clientes-incompletos-count', {
                     credentials: 'include',
                     signal: controller.signal
                 });
                 
                 clearTimeout(timeoutId);
                 
                 if (!response.ok) {
                     if (response.status === 401) {
                         window.location.href = '/login';
                         return;
                     }
                     return; // Silenciosamente falhar, não é crítico
                 }
                 
                 const data = await response.json();
                 
                 if (data && data.success) {
                     const badge = document.getElementById('incompleteBadge');
                     if (badge) {
                         const count = parseInt(data.count) || 0;
                         badge.textContent = count.toString();
                         if (count === 0) {
                             badge.style.display = 'none';
                         } else {
                             badge.style.display = 'flex';
                         }
                     }
                 }
             } catch (error) {
                 // Ignorar erros de cancelamento e timeout - não é crítico
                 if (error.name !== 'AbortError') {
                     // Silenciosamente falhar, badge não é essencial
                 }
             }
         }
         
         function toggleIncompleteClients() {
             const incompleteBtn = document.getElementById('incompleteClientsBtn');
             const toggleInput = document.getElementById('statusToggleInput');
             
             if (!incompleteBtn || !toggleInput) {
                 return;
             }
             
             // Alternar estado do filtro de incompletos
             showIncompleteClients = !showIncompleteClients;
             
             if (showIncompleteClients) {
                 // Ativar filtro de incompletos
                 incompleteBtn.classList.add('active');
                 
                 // Desativar toggle de status
                 toggleInput.checked = false;
                 currentStatusFilter = null;
                 updateToggleLabels();
             } else {
                 // Desativar filtro de incompletos
                 incompleteBtn.classList.remove('active');
                 
                 // Reativar filtro de status padrão (ativos)
                 currentStatusFilter = 'ativo';
                 toggleInput.checked = false;
                 updateToggleLabels();
             }
             
             // Recarregar lista
             currentPage = 1;
             loadClients();
             
             // Atualizar subtítulo
             updateSubtitle();
         }
    </script>

    <!-- Modal de Confirmação para Inativar Cliente -->
    <div id="inactivateModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-body">
                <h3 class="modal-title-simple">Confirmar inativar cliente <span id="modalClientName"></span>?</h3>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeInactivateModal()">
                    Cancelar
                </button>
                <button class="btn-confirm" id="confirmInactivateBtn" onclick="confirmInactivateClient()">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação para Ativar Cliente -->
    <div id="activateModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-body">
                <h3 class="modal-title-simple">Confirmar ativar cliente <span id="modalActivateClientName"></span>?</h3>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeActivateModal()">
                    Cancelar
                </button>
                <button class="btn-confirm activate-btn" id="confirmActivateBtn" onclick="confirmActivateClient()">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</body>
</html>
