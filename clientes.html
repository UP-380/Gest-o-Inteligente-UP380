<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP Gest√£o Inteligente - Clientes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">

</head>
<body>
    <!-- Sidebar Menu -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <a href="/painel" class="sidebar-item" title="Painel">
                <i class="fas fa-chart-bar"></i>
                <span class="sidebar-text">Painel</span>
            </a>
            <a href="clientes.html" class="sidebar-item active" title="Clientes">
                <i class="fas fa-users"></i>
                <span class="sidebar-text">Clientes</span>
            </a>
        </div>
        <div class="sidebar-support-icon" title="Suporte">
            <i class="fas fa-question-circle"></i>
            <span class="sidebar-text">Suporte/Melhorias</span>
        </div>
    </nav>
    <!-- Header azul escuro no topo -->
    <header class="top-header">
        <div class="header-container">
            <div class="header-left">
                <div class="header-logo">
                    <img src="assets/images/LOGO DO SISTEMA .png" alt="UP Gest√£o Inteligente" class="header-logo-img">
                </div>
            </div>

        </div>
    </header>
    
    <div class="container">
        <main class="main-content">
            <div class="form-header">
                <h2 class="form-title">Clientes</h2>
                <div class="form-header-actions">
                    <button class="add-client-btn" onclick="window.location.href='/portifolio-clientes'">
                        <i class="fas fa-gear"></i>
                        Clientes
                    </button>
                </div>
            </div>
            
            <!-- Se√ß√£o de Filtros Expostos -->
            <div class="exposed-filters-section">
                <div class="filters-row">
                    <!-- Filtro de Status -->
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <div class="status-filter-container">
                            <div class="status-select-field" id="statusSelectField">
                                <div class="status-select-display" id="statusSelectDisplay">
                                    <span class="status-select-text" id="statusSelectText">Selecionar status</span>
                                    <i class="fas fa-chevron-down status-select-arrow" id="statusSelectArrow"></i>
                                </div>
                                <div class="status-dropdown" id="statusDropdown" style="display: none;">
                                    <div class="status-dropdown-content">
                                        <!-- Op√ß√µes de status ser√£o inseridas aqui via JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro de Cliente -->
                    <div class="filter-group">
                        <label class="filter-label">Cliente</label>
                        <div class="cliente-filter-container">
                            <div class="cliente-select-field" id="clienteSelectField">
                                <div class="cliente-select-display" id="clienteSelectDisplay">
                                    <span class="cliente-select-text" id="clienteSelectText">Selecionar clientes</span>
                                    <i class="fas fa-chevron-down cliente-select-arrow" id="clienteSelectArrow"></i>
                                </div>
                                <div class="cliente-dropdown" id="clienteDropdown" style="display: none;">
                                    <div class="cliente-dropdown-content">
                                        <div class="cliente-search-container">
                                            <input type="text" id="clienteSearchInput" class="cliente-search-input" placeholder="Buscar cliente..." autocomplete="off">
                                        </div>
                                        <div class="cliente-options-container">
                                            <!-- Op√ß√µes de clientes com checkboxes ser√£o inseridas aqui via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro de Colaboradores -->
                    <div class="filter-group">
                        <label class="filter-label">Colaboradores</label>
                        <div class="colaborador-filter-container">
                            <div class="colaborador-select-field" id="colaboradorSelectField">
                                <div class="colaborador-select-display" id="colaboradorSelectDisplay">
                                    <span class="colaborador-select-text" id="colaboradorSelectText">Selecionar colaboradores</span>
                                    <i class="fas fa-chevron-down colaborador-select-arrow" id="colaboradorSelectArrow"></i>
                                </div>
                                <div class="colaborador-dropdown" id="colaboradorDropdown" style="display: none;">
                                    <div class="colaborador-dropdown-content">
                                        <div class="colaborador-search-container">
                                            <input type="text" id="colaboradorSearchInput" class="colaborador-search-input" placeholder="Buscar colaborador..." autocomplete="off">
                                        </div>
                                        <div class="colaborador-options-container">
                                            <!-- Op√ß√µes de colaboradores com checkboxes ser√£o inseridas aqui via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro de Per√≠odo -->
                    <div class="filter-group">
                        <label class="filter-label">Per√≠odo</label>
                    <div class="periodo-filter-container">
                        <div class="periodo-select-field" id="periodoSelectField">
                            <div class="periodo-select-display" id="periodoSelectDisplay">
                                <span class="periodo-select-text" id="periodoSelectText">Selecionar per√≠odo</span>
                                <i class="fas fa-chevron-down periodo-select-arrow" id="periodoSelectArrow"></i>
                            </div>
                            <div class="periodo-dropdown" id="periodoDropdown" style="display: none; margin-top: 8px;">
                                <div class="periodo-dropdown-content">
                                    <div class="month-selector-container">
                                        <label class="month-selector-label" for="monthSelector">Selecionar m√™s</label>
                                        <input type="month" id="monthSelector" class="month-selector-input" />
                                    </div>
                                    <div class="selected-dates-display">
                                        <div class="selected-date-item">
                                            <span class="date-label">In√≠cio</span>
                                            <span class="date-value" id="selectedStartDate">Selecione</span>
                                        </div>
                                        <div class="selected-date-item">
                                            <span class="date-label">Fim</span>
                                            <span class="date-value" id="selectedEndDate">Selecione</span>
                                        </div>
                                    </div>
                                    <div id="mainCalendar" class="calendar" style="margin-top: 6px;">
                                        <div class="calendar-header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                                            <button type="button" class="prev-month" title="M√™s anterior"><i class="fas fa-chevron-left"></i></button>
                                            <span class="calendar-month-year"></span>
                                            <button type="button" class="next-month" title="Pr√≥ximo m√™s"><i class="fas fa-chevron-right"></i></button>
                                        </div>
                                        <div class="calendar-days"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                
                <!-- Bot√µes de A√ß√£o dos Filtros -->
                <div class="filter-actions">
                    <button id="applyFiltersBtn" class="apply-filters-btn">Aplicar Filtros</button>
                    <button id="clearFiltersBtn" class="clear-filters-btn">Limpar Filtros</button>
                    <span id="periodoGlobalHoursText" style="margin-left: 12px; display: none; font-size: 13px; color: #444;">Global per√≠odo: 0,00 h</span>
                </div>
            </div>
            
            <!-- Container para os Cards Totais -->
            <div class="total-cards-container" id="totalCardsContainer" style="display: none;">
                <!-- Mini Card de Total de Clientes Filtrados -->
                <div class="clients-count-card" id="clientsCountCard" style="display: none;">
                    <div class="clients-count-content">
                        <i class="fas fa-users"></i>
                        <div class="clients-info">
                            <span class="clients-count-text" id="clientsCountText">0 clientes encontrados</span>
                        </div>
                    </div>
                </div>
                
                <!-- Mini Card de Total de Tarefas Filtradas -->
                <div class="tasks-count-card" id="tasksCountCard" style="display: none;">
                    <div class="tasks-count-content">
                        <i class="fas fa-tasks"></i>
                        <div class="tasks-info">
                            <span class="tasks-count-text" id="tasksCountText">0 tarefas encontradas</span>
                        </div>
                    </div>
                </div>
                
                <!-- INATIVO: Mini Card de Total de Horas Estimadas Filtradas
                <div class="estimated-hours-count-card" id="estimatedHoursCountCard" style="display: none;">
                    <div class="estimated-hours-count-content">
                        <i class="fas fa-clock"></i>
                        <div class="estimated-hours-info">
                            <span class="estimated-hours-count-text" id="estimatedHoursCountText">0 horas estimadas</span>
                            <span class="estimated-cost-count-text" id="estimatedCostCountText">Custo: R$ 0,00</span>
                        </div>
                    </div>
                </div>
                -->
                
                <!-- Mini Card de Total de Horas Realizadas Filtradas -->
                <div class="realized-hours-count-card" id="realizedHoursCountCard" style="display: none;">
                    <div class="realized-hours-count-content">
                        <i class="fas fa-check-circle"></i>
                        <div class="realized-hours-info">
                            <span class="realized-hours-count-text" id="realizedHoursCountText">0 horas realizadas</span>
                            <span class="realized-cost-count-text" id="realizedCostCountText">Custo: R$ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <!-- INATIVO: Mini Card de Diferen√ßa entre Horas Realizadas e Estimadas
                <div class="difference-count-card" id="differenceCountCard" style="display: none;">
                    <div class="difference-count-content">
                        <i class="fas fa-balance-scale"></i>
                        <div class="difference-info">
                            <span class="difference-hours-text" id="differenceHoursText">Diferen√ßa: 0,00 horas</span>
                            <span class="difference-cost-text" id="differenceCostText">Diferen√ßa: R$ 0,00</span>
                        </div>
                    </div>
                </div>
                -->
                
                <!-- Mini Card de Total de Faturamento Filtrado -->
                <div class="faturamento-count-card" id="faturamentoCountCard" style="display: none;">
                    <div class="faturamento-count-content">
                        <i class="fas fa-dollar-sign"></i>
                        <div class="faturamento-info">
                            <span class="faturamento-count-text" id="faturamentoCountText">Faturamento: R$ 0,00</span>
                            <span class="faturamento-registros-text" id="faturamentoRegistrosText">0 registros</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Template para linha de filtro -->
            <template id="filterRowTemplate">
                <div class="filter-row" data-filter-id="">
                    <div class="filter-type-section">
                        <select class="filter-type-select">
                            <option value="">Selecionar filtro</option>
                            <option value="status">Status</option>

                            <option value="cliente">Cliente</option>
                        </select>
                    </div>
                    <div class="filter-options-section" style="display: none;">
                        <!-- Op√ß√µes espec√≠ficas do filtro ser√£o inseridas aqui -->
                    </div>
                    <div class="filter-actions-section">
                        <button class="remove-filter-btn" title="Remover filtro">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            </template>
            
            <!-- Template para op√ß√µes de Status -->
            <template id="statusOptionsTemplate">
                <div class="status-filter-options">
                    <div class="status-checkboxes">
                        <!-- Checkboxes ser√£o inseridos aqui via JavaScript -->
                    </div>
                </div>
            </template>
            
>
            
            <!-- Template para op√ß√µes de Cliente -->
            <template id="clienteOptionsTemplate">
                <div class="cliente-filter-options">
                    <div class="cliente-search-container">
                        <input type="text" class="cliente-search-input" placeholder="Buscar cliente..." autocomplete="off">
                        <div class="cliente-dropdown" style="display: none;">
                            <!-- Op√ß√µes de clientes ser√£o inseridas aqui via JavaScript -->
                        </div>
                    </div>
                    <div class="selected-clientes-container">
                        <div class="selected-clientes-label">Clientes selecionados:</div>
                        <div class="selected-clientes-list">
                            <!-- Clientes selecionados ser√£o mostrados aqui -->
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Se√ß√£o de Cards dos Clientes -->
            <div class="dashboard-content">
                <div class="clients-section">
                    <div class="clients-grid" id="clientsGrid">
                        <!-- Cards dos clientes ser√£o inseridos aqui via JavaScript -->
                        <div class="loading-message" id="loadingMessage">
                            <i class="fas fa-spinner fa-spin"></i>
                            Carregando clientes...
                        </div>
                    </div>
                    
                    <!-- ========================================
                         üöÄ CONTROLES DE PAGINA√á√ÉO
                         ======================================== -->
                    <div class="pagination-container" id="paginationContainer" style="display: none;">
                        <!-- Selector de itens por p√°gina -->
                        <div class="pagination-limit-selector">
                            <label for="paginationLimit">Exibir:</label>
                            <select id="paginationLimit" class="pagination-limit-select">
                                <option value="10">10 itens</option>
                                <option value="20" selected>20 itens</option>
                                <option value="30">30 itens</option>
                            </select>
                        </div>
                        
                        <!-- Informa√ß√µes de pagina√ß√£o -->
                        <div class="pagination-info">
                            <span id="paginationInfo">Mostrando 0 de 0 clientes</span>
                        </div>
                        
                        <!-- Bot√µes de navega√ß√£o -->
                        <div class="pagination-controls">
                            <button id="firstPageBtn" class="pagination-btn" title="Primeira p√°gina">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button id="prevPageBtn" class="pagination-btn" title="P√°gina anterior">
                                <i class="fas fa-angle-left"></i>
                            </button>
                            
                            <span class="pagination-current">
                                P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span>
                            </span>
                            
                            <button id="nextPageBtn" class="pagination-btn" title="Pr√≥xima p√°gina">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button id="lastPageBtn" class="pagination-btn" title="√öltima p√°gina">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    



    <script src="auth-check.js"></script>
    <script src="clientes.js?v=99999999999999"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    try {
      const addBtn = document.querySelector('.add-client-btn');
      const actions = document.querySelector('.form-header-actions');
      if (addBtn && actions) {
        const alertBtn = document.createElement('button');
        alertBtn.id = 'alertTasksBtn';
        alertBtn.className = 'incomplete-clients-btn';
        alertBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Tarefas Desajustadas <span class="incomplete-badge" id="desajustadasBadge">0</span>';
        // Inserir o alerta antes do bot√£o Clientes dentro do container de a√ß√µes
        actions.insertBefore(alertBtn, addBtn);
        alertBtn.addEventListener('click', toggleTarefasDesajustadasPanel);
      }
      loadTarefasDesajustadasCount();
      setupTarefasDesajustadasPanel();
    } catch (e) {
      console.error('Falha ao inicializar bot√£o de alerta de tarefas:', e);
    }
  });

  async function loadTarefasDesajustadasCount() {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      const resp = await fetch('/api/tarefas-incompletas', { credentials: 'include', signal: controller.signal });
      clearTimeout(timeoutId);
      if (!resp.ok) {
        if (resp.status === 401) {
          window.location.href = '/login';
          return;
        }
        return;
      }
      const payload = await resp.json();
      const count = parseInt(payload.count) || (Array.isArray(payload.items) ? payload.items.length : 0) || 0;
      const badge = document.getElementById('desajustadasBadge');
      if (badge) {
        badge.textContent = String(count);
        badge.style.display = count === 0 ? 'none' : 'flex';
      }
    } catch (error) {}
  }

  function setupTarefasDesajustadasPanel() {
    // Criar cont√™iner logo abaixo dos bot√µes de filtro
    const applyBtn = document.getElementById('applyFiltersBtn');
    if (!applyBtn) return;
    if (document.getElementById('tarefasDesajustadasPanel')) return;
    const panel = document.createElement('div');
    panel.id = 'tarefasDesajustadasPanel';
    panel.style.display = 'none';
    panel.style.marginTop = '12px';
    panel.style.border = '1px solid #eee';
    panel.style.borderRadius = '8px';
    panel.style.padding = '12px';
    panel.style.background = '#fff';

    const info = document.createElement('div');
    info.style.marginBottom = '8px';
    info.style.color = '#555';
    info.style.fontSize = '14px';
    info.textContent = 'Listando tarefas com campos faltando.';

    const listContainer = document.createElement('div');
    listContainer.id = 'tarefas-desajustadas-list';

    panel.appendChild(info);
    panel.appendChild(listContainer);
    // Inserir logo abaixo do cont√™iner dos bot√µes
    applyBtn.parentNode.insertAdjacentElement('afterend', panel);

    // Fechar automaticamente ao aplicar filtros
    applyBtn.addEventListener('click', closeTarefasDesajustadasPanel);
  }

  function toggleTarefasDesajustadasPanel() {
    const panel = document.getElementById('tarefasDesajustadasPanel');
    const alertBtn = document.getElementById('alertTasksBtn');
    if (!panel || !alertBtn) return;
    const isOpen = panel.style.display !== 'none';
    if (isOpen) {
      panel.style.display = 'none';
      alertBtn.classList.remove('active');
    } else {
      panel.style.display = 'block';
      alertBtn.classList.add('active');
      renderIncompleteTasksLoading();
      fetchIncompleteTasks();
    }
  }

  function closeTarefasDesajustadasPanel() {
    const panel = document.getElementById('tarefasDesajustadasPanel');
    const alertBtn = document.getElementById('alertTasksBtn');
    if (!panel) return;
    panel.style.display = 'none';
    if (alertBtn) alertBtn.classList.remove('active');
  }

  function renderIncompleteTasksLoading() {
    const list = document.getElementById('tarefas-desajustadas-list');
    if (!list) return;
    // Spinner discreto, apenas √≠cone
    list.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size:12px;color:#999"></i>';
  }

  async function fetchIncompleteTasks() {
    try {
      const resp = await fetch('/api/tarefas-incompletas', { credentials: 'include' });
      if (!resp.ok) throw new Error('Falha ao buscar tarefas desajustadas');
      const payload = await resp.json();
      const badge = document.getElementById('desajustadasBadge');
      if (badge) {
        const c = parseInt(payload.count) || (Array.isArray(payload.items) ? payload.items.length : 0) || 0;
        badge.textContent = String(c);
        badge.style.display = c === 0 ? 'none' : 'flex';
      }
      await renderIncompleteTasks(payload.items || []);
    } catch (err) {
      const list = document.getElementById('tarefas-desajustadas-list');
      if (list) list.innerHTML = `<div class=\"error\">${err.message}</div>`;
      console.error(err);
    }
  }

  let __clientesMap = null;
  async function ensureClientesMap() {
    if (__clientesMap) return __clientesMap;
    try {
      const resp = await fetch('/api/clientes-filtro');
      const data = await resp.json();
      const map = {};
      if (data && data.success && Array.isArray(data.clientes)) {
        data.clientes.forEach(c => { if (c && c.id) map[String(c.id)] = c.nome || String(c.id); });
      }
      __clientesMap = map;
      return map;
    } catch (_) {
      __clientesMap = {};
      return __clientesMap;
    }
  }

  async function renderIncompleteTasks(items) {
    const clientesMap = await ensureClientesMap();
    const list = document.getElementById('tarefas-desajustadas-list');
    if (!list) return;
    if (!items.length) {
      list.innerHTML = '<div class="empty">Nenhuma tarefa desajustada encontrada.</div>';
      return;
    }

    const formatDate = (v) => {
      if (!v) return null;
      const d = new Date(v);
      return isNaN(d.getTime()) ? String(v) : d.toLocaleDateString('pt-BR');
    };

    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';

    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    const headers = ['ID', 'Data In√≠cio', 'Data Vencimento', 'Cliente', 'Abrir'];
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      th.style.textAlign = 'left';
      th.style.borderBottom = '1px solid #ddd';
      th.style.padding = '8px';
      th.style.fontWeight = '600';
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);

    const tbody = document.createElement('tbody');
    items.forEach(t => {
      const tr = document.createElement('tr');
      const missing = Array.isArray(t.missing) ? t.missing : [
        !t.dt_inicio ? 'dt_inicio' : null,
        !t.dt_vencimento ? 'dt_vencimento' : null,
        !t.cliente_id ? 'cliente_id' : null,
      ].filter(Boolean);

      const tdId = document.createElement('td');
      tdId.textContent = t.id;
      tdId.style.padding = '8px';
      tdId.style.borderBottom = '1px solid #f0f0f0';
      tr.appendChild(tdId);

      const tdInicio = document.createElement('td');
      const inicioVal = formatDate(t.dt_inicio);
      tdInicio.textContent = inicioVal || 'X';
      tdInicio.style.color = inicioVal ? '#333' : '#fd7e14';
      tdInicio.style.fontWeight = inicioVal ? '400' : '600';
      tdInicio.style.textAlign = 'left';
      tdInicio.style.padding = '8px';
      tdInicio.style.borderBottom = '1px solid #f0f0f0';
      tr.appendChild(tdInicio);

      const tdVenc = document.createElement('td');
      const vencVal = formatDate(t.dt_vencimento);
      tdVenc.textContent = vencVal || 'X';
      tdVenc.style.color = vencVal ? '#333' : '#fd7e14';
      tdVenc.style.fontWeight = vencVal ? '400' : '600';
      tdVenc.style.textAlign = 'left';
      tdVenc.style.padding = '8px';
      tdVenc.style.borderBottom = '1px solid #f0f0f0';
      tr.appendChild(tdVenc);

      const tdCliente = document.createElement('td');
      tdCliente.style.padding = '8px';
      tdCliente.style.borderBottom = '1px solid #f0f0f0';
      const clienteRaw = t.cliente_id ? String(t.cliente_id) : '';
      if (!clienteRaw) {
        tdCliente.style.textAlign = 'left';
        const x = document.createElement('span');
        x.textContent = 'X';
        x.style.color = '#fd7e14';
        x.style.fontWeight = '600';
        tdCliente.appendChild(x);
      } else {
        const ids = clienteRaw.split(',').map(s => s.trim()).filter(Boolean);
        const wrap = document.createElement('div');
        wrap.className = 'cliente-tags';
        ids.forEach(id => {
          const name = clientesMap[id] || id;
          const tag = document.createElement('span');
          tag.className = 'cliente-tag-orange';
          tag.textContent = name;
          wrap.appendChild(tag);
        });
        tdCliente.appendChild(wrap);
      }
      tr.appendChild(tdCliente);

      const tdAbrir = document.createElement('td');
      tdAbrir.style.padding = '8px';
      tdAbrir.style.borderBottom = '1px solid #f0f0f0';
      if (t.url && String(t.url).trim() !== '') {
        const btn = document.createElement('button');
        btn.className = 'tarefa-redirect-btn';
        btn.title = 'Abrir tarefa';
        btn.setAttribute('data-url', t.url);
        btn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openTarefaUrl(t.url);
        });
        tdAbrir.appendChild(btn);
      } else {
        tdAbrir.textContent = '-';
        tdAbrir.style.color = '#999';
      }
      tr.appendChild(tdAbrir);

      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    list.innerHTML = '';
    list.appendChild(table);
  }
</script>
</body>
</html>
